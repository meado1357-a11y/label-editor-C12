<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê¸€ë˜ìŠ¤ë§ˆì¼“ V28.9 (ê°€ì´ë“œ ë³µêµ¬)</title>
    <script src="https://unpkg.com/fabric@5.3.0/dist/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --row-gap: 4.55mm; 
            --page-padding-top: 15.1mm;
            --page-padding-left: 6.5mm;
            --circle-size: 63mm;
            --column-gap: 4mm;
        }
        body { margin: 0; padding: 0; background: #f0f0f0; font-family: 'Pretendard', sans-serif; display: flex; flex-direction: column; align-items: center; }
        .controls { position: fixed; top: 10px; left: 10px; background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.4); z-index: 10000; width: 310px; max-height: 95vh; overflow-y: auto; }
        .controls-header { background: linear-gradient(135deg, #ff85b1 0%, #ff7e5f 100%); color: white; padding: 15px; cursor: move; font-weight: bold; text-align: center; border-radius: 12px 12px 0 0; }
        .controls-content { padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        
        .print-guide { background: #fff9db; border: 1px solid #fab005; border-radius: 8px; padding: 12px; font-size: 13px; line-height: 1.6; color: #333; }
        .guide-title { font-weight: 800; color: #d9480f; display: block; margin-bottom: 6px; border-bottom: 2px solid #ffe066; padding-bottom: 2px; }

        .page { width: 210mm; height: 297mm; background: white; margin: 20px; display: grid; grid-template-columns: repeat(3, var(--circle-size)); grid-template-rows: repeat(4, var(--circle-size)); padding-top: var(--page-padding-top); padding-left: var(--page-padding-left); column-gap: var(--column-gap); row-gap: var(--row-gap); box-sizing: border-box; box-shadow: 0 0 30px rgba(0,0,0,0.3); position: relative; }
        .circle-slot { width: var(--circle-size); height: var(--circle-size); position: relative; border-radius: 50%; border: 1.5px dashed #ff85b1; background: #fff; display: flex; justify-content: center; align-items: center; overflow: hidden; }

        .btn-main { background: #ffffff; border: 2px solid #ff85b1; color: #ff85b1; width: 100%; padding: 10px; cursor: pointer; font-weight: bold; border-radius: 8px; transition: 0.2s; font-size: 14px; }
        .btn-main:hover { background: #ff85b1; color: white; }
        .btn-group-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; }
        .btn-sub { padding: 8px 0; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 11px; }
        .btn-save-max { background: linear-gradient(to right, #ff7e5f, #feb47b); color: white; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }

        .switch-box { background: #f8f9fa; padding: 10px; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; font-weight: bold; border: 1px solid #eee; font-size: 13px; }
        .switch { position: relative; display: inline-block; width: 34px; height: 18px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #ff85b1; }
        input:checked + .slider:before { transform: translateX(16px); }

        @media print { body { background: none; } .no-print { display: none !important; } .page { margin: 0; box-shadow: none; border: none; } .circle-slot { border: none !important; } }
    </style>
</head>
<body>

<div class="controls no-print" id="dragBox">
    <div class="controls-header" id="dragHandle">ğŸ’ ê¸€ë˜ìŠ¤ë§ˆì¼“ V28.9</div>
    <div class="controls-content">
        <div class="switch-box"><span>ğŸ›¡ï¸ ì˜¤ì°¨ ë°©ì§€ ê¸°ëŠ¥(1mm í™•ì¥)</span><label class="switch"><input type="checkbox" id="bleedToggle" checked><span class="slider"></span></label></div>
        <div class="switch-box"><span>ğŸ”— ì „ì²´ ì¹¸ ë™ê¸°í™”</span><label class="switch"><input type="checkbox" id="allSyncToggle" checked onchange="toggleAllSync(this.checked)"><span class="slider"></span></label></div>
        
        <button class="btn-main" onclick="document.getElementById('fileAll').click()">ğŸ–¼ï¸ ì‚¬ì§„ ì¼ê´„ ë“±ë¡</button>
        <input type="file" id="fileAll" accept="image/*" style="display:none;" onchange="loadAllImages(event)">
        
        <div class="btn-group-row">
            <button class="btn-sub" style="background:#e7f5ff; color:#1971c2;" onclick="undo()">â†©ï¸ ì·¨ì†Œ</button>
            <button class="btn-sub" style="background:#fff5f5; color:#fa5252;" onclick="deleteSelected()">ğŸ—‘ï¸ ì‚­ì œ</button>
            <button class="btn-sub" style="background:#f1f3f5; color:#495057;" onclick="clearAll()">ğŸ”¥ ì´ˆê¸°í™”</button>
        </div>

        <div style="background: #fff0f6; padding: 10px; border-radius: 8px; border: 1px solid #ffdeeb; display: flex; flex-direction: column; gap: 8px;">
            <button class="btn-main" style="background:#ff85b1; color:white; border:none;" onclick="addText()">â• ê¸€ìƒì ì¶”ê°€</button>
            <div style="display:flex; gap:5px;">
                <select id="fontSelect" style="flex:2; padding:8px; border-radius:6px; border:1px solid #ddd;" onchange="updateFont()"><option value="Pretendard">Pretendard</option></select>
                <input type="color" id="textColor" value="#000000" style="flex:1; height:35px; border:none; cursor:pointer;" onchange="updateTextColor()">
            </div>
            <button class="btn-main" style="font-size:11px; padding:5px; border:1px dashed #ff85b1;" onclick="loadSystemFonts()">ğŸ”„ PC ê¸€ê¼´ ë™ê¸°í™”</button>
        </div>

        <button class="btn-save-max" onclick="exportLossless()">ğŸ’¾ ì´ˆê³ í™”ì§ˆ PDF ì €ì¥</button>
        <button class="btn-main" style="border:2px solid #ff7e5f; color:#ff7e5f;" onclick="window.print()">ğŸ–¨ï¸ ë°”ë¡œ ì €í™”ì§ˆ ì¸ì‡„</button>

        <div class="print-guide">
            <span class="guide-title">âš™ï¸ ì¸ì‡„ ì„¤ì • ë°©ë²•</span>
            <div style="margin-bottom: 5px;">ğŸ“ ë°”ë¡œ ì €í™”ì§ˆ ì¸ì‡„ : ë°°ìœ¨ <b>[ê¸°ë³¸ê°’]</b></div>
            <div style="margin-bottom: 5px;">ğŸ“ PDF ì €ì¥ í›„ ì¸ì‡„ : ë°°ìœ¨ <b>[100%]</b></div>
            <div style="font-size:11px; color:#666; border-top: 1px solid #ffe066; padding-top:4px;">* ì—¬ë°±ì€ <b>[ì—†ìŒ]</b>ìœ¼ë¡œ ì„¤ì •í•´ì•¼ ì •í™•í•©ë‹ˆë‹¤.</div>
        </div>
    </div>
</div>

<div class="page" id="labelPage"></div>

<script>
    const canvases = [];
    const labelPage = document.getElementById('labelPage');

    for (let i = 0; i < 12; i++) {
        const slot = document.createElement('div');
        slot.className = 'circle-slot';
        slot.innerHTML = `<canvas id="canvas${i}"></canvas>
            <button class="no-print" style="position:absolute; top:5px; z-index:100; background:rgba(0,0,0,0.6); color:white; border:none; padding:2px 8px; border-radius:4px; font-size:10px; cursor:pointer;" onclick="document.getElementById('file${i}').click()">êµì²´</button>
            <div class="no-print" style="position:absolute; bottom:5px; z-index:100; font-size:10px; background:white; padding:2px 8px; border-radius:20px; border:1px solid #eee; display:flex; align-items:center; gap:4px;"><input type="checkbox" class="sync-check" id="sync${i}" checked><label>ë™ê¸°í™”</label></div>
            <input type="file" id="file${i}" accept="image/*" style="display:none;" onchange="loadImage(event, ${i})">`;
        labelPage.appendChild(slot);
    }

    window.onload = function() {
        for (let i = 0; i < 12; i++) {
            const canvas = new fabric.Canvas('canvas' + i, { width: 238, height: 238, centeredScaling: true, centeredRotation: true });
            
            // [ë³µêµ¬] ì›í˜• ë§ˆìŠ¤í¬ ê°€ì´ë“œ - í™”ë©´ í¸ì§‘ ì‹œì—ëŠ” ë¬´ì¡°ê±´ ë™ê·¸ë—ê²Œ ë³´ì´ê²Œ í•¨
            canvas.clipPath = new fabric.Circle({ radius: 119, left: 119, top: 119, originX: 'center', originY: 'center', absolutePositioned: true });

            canvas.on('mouse:wheel', function(opt) {
                const delta = opt.e.deltaY;
                const activeObj = canvas.getActiveObject() || canvas.getObjects()[0];
                if (!activeObj) return;
                let scale = activeObj.scaleX * Math.pow(0.999, delta);
                if (scale < 0.01) scale = 0.01;
                if (document.getElementById('sync' + i).checked) {
                    const objIdx = canvas.getObjects().indexOf(activeObj);
                    canvases.forEach((c, idx) => {
                        if (document.getElementById('sync' + idx).checked) {
                            const obj = c.getObjects()[objIdx];
                            if (obj) { obj.scale(scale); c.renderAll(); }
                        }
                    });
                } else { activeObj.scale(scale); canvas.renderAll(); }
                opt.e.preventDefault(); opt.e.stopPropagation();
            });

            const syncHandler = (e) => {
                if (!document.getElementById('sync' + i).checked) return;
                const obj = e.target;
                const objIdx = canvas.getObjects().indexOf(obj);
                canvases.forEach((c, idx) => {
                    if (idx !== i && document.getElementById('sync' + idx).checked) {
                        const targetObj = c.getObjects()[objIdx];
                        if (targetObj) {
                            targetObj.set({ left: obj.left, top: obj.top, scaleX: obj.scaleX, scaleY: obj.scaleY, angle: obj.angle });
                            c.renderAll();
                        }
                    }
                });
            };
            canvas.on('object:moving', syncHandler); canvas.on('object:scaling', syncHandler); canvas.on('object:rotating', syncHandler);
            canvases.push(canvas);
        }
        initDraggable(document.getElementById("dragBox"));
    };

    function loadImage(event, index) {
        const file = event.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = (f) => { fabric.Image.fromURL(f.target.result, (img) => { 
            img.set({ originX: 'center', originY: 'center', left: 119, top: 119 });
            img.scale(Math.max(238/img.width, 238/img.height));
            canvases[index].clear().add(img).setActiveObject(img); canvases[index].renderAll(); 
        }); };
        reader.readAsDataURL(file);
    }

    function loadAllImages(event) {
        const file = event.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = (f) => {
            const url = f.target.result;
            canvases.forEach(c => { fabric.Image.fromURL(url, (img) => { 
                img.set({ originX: 'center', originY: 'center', left: 119, top: 119 });
                img.scale(Math.max(238/img.width, 238/img.height));
                c.clear().add(img); c.renderAll(); 
            }); });
        };
        reader.readAsDataURL(file);
    }

    function toggleAllSync(val) { document.querySelectorAll('.sync-check').forEach(c => c.checked = val); }
    function addText() { const text = new fabric.IText('í…ìŠ¤íŠ¸', { left: 119, top: 119, originX: 'center', originY: 'center', fontSize: 30, fontFamily: 'Pretendard', fill: document.getElementById('textColor').value }); canvases.forEach(c => { c.add(text); c.renderAll(); }); }
    function updateFont() { const font = document.getElementById('fontSelect').value; canvases.forEach(c => { c.getObjects('i-text').forEach(obj => obj.set('fontFamily', font)); c.renderAll(); }); }
    function updateTextColor() { const color = document.getElementById('textColor').value; canvases.forEach(c => { c.getObjects('i-text').forEach(obj => obj.set('fill', color)); c.renderAll(); }); }
    function clearAll() { if(confirm("ì´ˆê¸°í™”?")) { canvases.forEach(c => { c.clear(); c.renderAll(); }); } }
    function deleteSelected() { canvases.forEach(c => { c.getActiveObjects().forEach(obj => c.remove(obj)); c.discardActiveObject().renderAll(); }); }
    async function loadSystemFonts() { if (!window.queryLocalFonts) return alert("í¬ë¡¬ ë¸Œë¼ìš°ì € ì „ìš©"); try { const fonts = await window.queryLocalFonts(); const fontSelect = document.getElementById('fontSelect'); [...new Set(fonts.map(f => f.family))].sort().forEach(font => { const opt = document.createElement('option'); opt.value = font; opt.textContent = font; fontSelect.appendChild(opt); }); alert("ì™„ë£Œ"); } catch (e) { alert("ê±°ë¶€"); } }

    async function exportLossless() {
        const btn = event.target; btn.innerText = "ğŸš€ ê³ í•´ìƒë„ ìƒì„± ì¤‘...";
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        const exportCanvas = document.createElement('canvas');
        const ctx = exportCanvas.getContext('2d');
        exportCanvas.width = 2480; exportCanvas.height = 3508;
        ctx.fillStyle = "white"; ctx.fillRect(0, 0, 2480, 3508);
        const mmToPx = 2480 / 210;

        const rootStyle = getComputedStyle(document.documentElement);
        const rowGapVal = parseFloat(rootStyle.getPropertyValue('--row-gap'));
        const rowGapPx = rowGapVal * mmToPx;
        const sizePx = 63 * mmToPx;
        const topPx = 15.1 * mmToPx;
        const leftPx = 6.5 * mmToPx;
        const colGapPx = 4 * mmToPx;
        
        // ë„ë ¨ ìˆ˜ì¹˜ (ì‚¬ë°© 1mm)
        const isBleed = document.getElementById('bleedToggle').checked;
        const bleedPx = isBleed ? 1 * mmToPx : 0; 

        for (let i = 0; i < 12; i++) {
            const col = i % 3; const row = Math.floor(i / 3);
            const targetX = leftPx + (col * (sizePx + colGapPx));
            const targetY = topPx + (row * (sizePx + rowGapPx));
            
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = sizePx + (bleedPx * 2); 
            tempCanvas.height = sizePx + (bleedPx * 2);
            const tempCtx = tempCanvas.getContext('2d');

            // [PDF ì €ì¥ ì‹œì—ë§Œ ë„ë ¨ ì ìš©] í´ë¦¬í•‘ ì—†ì´ ì´ë¯¸ì§€ ì „ì²´ë¥¼ ì¶œë ¥ í¬ê¸°ì— ë§ì¶° í™•ì¥
            const dataURL = canvases[i].toDataURL({ format: 'png', multiplier: (sizePx / 238), enableRetinaScaling: true });
            const img = await new Promise(res => { const img = new Image(); img.onload = () => res(img); img.src = dataURL; });
            
            tempCtx.drawImage(img, 0, 0, tempCanvas.width, tempCanvas.height);
            ctx.drawImage(tempCanvas, targetX - bleedPx, targetY - bleedPx);
        }
        pdf.addImage(exportCanvas.toDataURL('image/jpeg', 0.98), 'JPEG', 0, 0, 210, 297);
        pdf.save('sticker_V28.9.pdf');
        btn.innerText = "ğŸ’¾ ì´ˆê³ í™”ì§ˆ PDF ì €ì¥";
    }

    function initDraggable(el) {
        const h = document.getElementById("dragHandle");
        h.onmousedown = (e) => {
            let x = e.clientX - el.offsetLeft; let y = e.clientY - el.offsetTop;
            document.onmousemove = (e) => { el.style.left = (e.clientX - x) + "px"; el.style.top = (e.clientY - y) + "px"; };
            document.onmouseup = () => { document.onmousemove = null; };
        };
    }
    function undo() { alert("ì‹¤í–‰ ì·¨ì†ŒëŠ” ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤."); }
</script>
</body>
</html>
