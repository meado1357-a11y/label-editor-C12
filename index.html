<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê¸€ë˜ìŠ¤ë§ˆì¼“ ë¼ë²¨ V15.0 (Final Edition)</title>
    <script src="https://unpkg.com/fabric@5.3.0/dist/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { margin: 0; padding: 0; background: #f0f0f0; font-family: 'Pretendard', sans-serif; display: flex; flex-direction: column; align-items: center; }
        .page {
            width: 210mm; height: 297mm; background: white; margin: 20px; display: grid;
            grid-template-columns: repeat(3, 63mm); grid-template-rows: repeat(4, 63mm);
            padding: 15mm 6.5mm 16.02mm 6.5mm; column-gap: 4mm; row-gap: 4.66mm;
            box-sizing: border-box; box-shadow: 0 0 20px rgba(0,0,0,0.2);
        }

        /* ì›í˜• ìŠ¬ë¡¯ ê³ ì • */
        .circle-slot {
            width: 63mm; height: 63mm; position: relative;
            display: flex; justify-content: center; align-items: center;
            overflow: hidden !important; border-radius: 50%;
            border: 1px dashed #ff85b1; background: #fff;
            -webkit-mask-image: radial-gradient(circle, white 100%, black 100%);
            mask-image: radial-gradient(circle, white 100%, black 100%);
        }

        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ - ë¦¬ì‚¬ì´ì¦ˆ ê°€ëŠ¥í•˜ë„ë¡ ìˆ˜ì • */
        .controls { 
            position: fixed; top: 10px; left: 10px; background: white; 
            border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
            z-index: 10000; width: 280px; min-width: 250px; min-height: 400px;
            overflow: auto; resize: both; /* í¬ê¸° ì¡°ì ˆ ê°€ëŠ¥ */
        }
        .controls-header { background: #ff85b1; color: white; padding: 12px; cursor: move; font-weight: bold; text-align: center; border-radius: 12px 12px 0 0; }
        .controls-content { padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        
        .switch-box { background: #f8f9fa; padding: 0.8em; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; font-size: 0.9em; border: 1px solid #eee; font-weight: bold; }
        .btn-group { display: flex; gap: 5px; }
        .btn { flex: 1; padding: 0.8em 0.4em; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; font-size: 0.85em; transition: 0.2s; }
        .btn-undo { background: #c9d8ff; color: #3b5bdb; } 
        .btn-del { background: #fff3c9; color: #8a6d10; } 
        .btn-clear { background: #ffd1c9; color: #c92a2a; }
        .btn:hover { opacity: 0.8; }

        .btn-main { background: #f8f9fa; border: 1px solid #dee2e6; width: 100%; font-size: 0.85em; padding: 0.8em; cursor: pointer; font-weight: bold; border-radius: 6px; }
        .btn-print { background: #ff85b1; color: white; padding: 1em; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1em; margin-top: 5px; box-shadow: 0 4px 10px rgba(255, 133, 177, 0.3); }
        
        /* ê¸€ê¼´ ì„¤ì • ì˜ì—­ */
        .text-panel { background: #fff8fa; padding: 10px; border-radius: 8px; border: 1px solid #ffe0eb; display: flex; flex-direction: column; gap: 8px; }
        .select-input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85em; }

        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #ff85b1; }
        input:checked + .slider:before { transform: translateX(20px); }

        .individual-btn { position: absolute; top: 8%; z-index: 100; background: rgba(255, 133, 177, 0.9); color: white; border: none; padding: 4px 10px; border-radius: 20px; font-size: 11px; cursor: pointer; }
        .sync-wrapper { position: absolute; bottom: 8%; z-index: 100; font-size: 11px; background: white; padding: 3px 8px; border-radius: 20px; border: 1px solid #eee; cursor: pointer; display: flex; align-items: center; gap: 4px; }

        @media print {
            @page { size: A4; margin: 0; }
            .no-print { display: none !important; }
            .page { margin: 0 !important; border: none !important; box-shadow: none !important; }
            .circle-slot { -webkit-mask-image: none !important; mask-image: none !important; border: none !important; }
            body:not(.bleed-active) .circle-slot { border-radius: 50% !important; overflow: hidden !important; clip-path: circle(50%); }
        }
    </style>
</head>
<body class="bleed-active">

<div class="controls no-print" id="dragBox">
    <div class="controls-header" id="dragHandle">âœ¨ ë¼ë²¨ ì—ë””í„° V15.0</div>
    <div class="controls-content">
        <div class="switch-box">
            <span>ğŸ›¡ï¸ ì˜¤ì°¨ ë°©ì§€ ëª¨ë“œ</span>
            <label class="switch"><input type="checkbox" id="bleedToggle" checked onchange="updateBleedMode()"><span class="slider"></span></label>
        </div>
        <div class="switch-box">
            <span>ğŸ”— ëª¨ë“  ì¹¸ ë™ê¸°í™”</span>
            <label class="switch"><input type="checkbox" id="allSyncToggle" checked onchange="toggleAllSync(this.checked)"><span class="slider"></span></label>
        </div>
        
        <button class="btn-main" onclick="document.getElementById('fileAll').click()">ğŸ–¼ï¸ í•œêº¼ë²ˆì— ì‚¬ì§„ ì±„ìš°ê¸°</button>
        <input type="file" id="fileAll" accept="image/*" style="display:none;" onchange="loadAllImages(event)">
        
        <div class="btn-group">
            <button class="btn btn-undo" onclick="undo()">â†©ï¸ ì´ì „</button>
            <button class="btn btn-del" onclick="deleteSelected()">ğŸ—‘ï¸ ì‚­ì œ</button>
            <button class="btn btn-clear" onclick="clearAll()">ğŸ”¥ ì´ˆê¸°í™”</button>
        </div>

        <div class="text-panel">
            <button class="btn-main" style="background:#ff85b1; color:white; border:none;" onclick="addText()">â• ê¸€ìƒì ì¶”ê°€</button>
            <select id="fontSelect" class="select-input" onchange="updateFont()">
                <option value="Pretendard">Pretendard (ê¸°ë³¸)</option>
                <option value="Nanum Gothic">ë‚˜ëˆ”ê³ ë”•</option>
                <option value="Nanum Myeongjo">ë‚˜ëˆ”ëª…ì¡°</option>
                <option value="Gungsuh">ê¶ì„œì²´</option>
                <option value="Arial">Arial</option>
                <option value="Verdana">Verdana</option>
                <option value="Courier New">Courier New</option>
            </select>
            <input type="color" id="textColor" value="#000000" style="width:100%; height:30px; border:none; cursor:pointer;" onchange="updateTextColor()">
        </div>

        <div class="save-grid" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:4px;">
            <button class="btn btn-save" style="background:#e3e3e3;" onclick="exportFile('png')">PNG ì €ì¥</button>
            <button class="btn btn-save" style="background:#e3e3e3;" onclick="exportFile('jpg')">JPG ì €ì¥</button>
            <button class="btn btn-save" style="background:#e3e3e3;" onclick="exportFile('pdf')">PDF ì €ì¥</button>
        </div>
        
        <button class="btn-print" onclick="window.print()">ğŸ–¨ï¸ ê³ í™”ì§ˆ ì¸ì‡„í•˜ê¸°</button>
    </div>
</div>

<div class="page" id="labelPage">
    <script>
        const canvases = [];
        const SIZE = 238; 
        const CENTER = SIZE / 2;
        let historyStack = [];

        for (let i = 0; i < 12; i++) {
            document.write(`
                <div class="circle-slot" id="slot${i}">
                    <button class="individual-btn no-print" onclick="document.getElementById('file${i}').click()">ì‚¬ì§„ ì„ íƒ</button>
                    <div class="sync-wrapper no-print" onclick="manualSyncToggle(${i})">
                        <input type="checkbox" class="sync-check" id="sync${i}" checked> <label>ë™ê¸°í™”</label>
                    </div>
                    <canvas id="canvas${i}"></canvas>
                    <input type="file" id="file${i}" accept="image/*" style="display:none;" onchange="loadImage(event, ${i})">
                </div>
            `);
        }

        window.onload = function() {
            for (let i = 0; i < 12; i++) {
                const canvas = new fabric.Canvas('canvas' + i, { width: SIZE, height: SIZE, backgroundColor: 'transparent' });
                updateCanvasClip(canvas);

                canvas.on('mouse:wheel', (opt) => {
                    const delta = opt.e.deltaY;
                    let zoom = canvas.getZoom() * Math.pow(0.9995, delta);
                    zoom = Math.min(Math.max(zoom, 0.01), 10);
                    const point = new fabric.Point(CENTER, CENTER);
                    if (document.getElementById('sync' + i).checked) {
                        canvases.forEach((c, idx) => { if (document.getElementById('sync' + idx).checked) { c.zoomToPoint(point, zoom); c.renderAll(); } });
                    } else { canvas.zoomToPoint(point, zoom); canvas.renderAll(); }
                    saveState(); opt.e.preventDefault();
                });
                canvas.on('object:modified', saveState);
                canvases.push(canvas);
            }
            updateBleedMode();
            saveState();
            initDraggable(document.getElementById("dragBox"));
        };

        function updateCanvasClip(canvas) {
            const isBleed = document.getElementById('bleedToggle').checked;
            canvas.clipPath = isBleed ? null : new fabric.Circle({ radius: CENTER, left: CENTER, top: CENTER, originX: 'center', originY: 'center', absolutePositioned: true });
            canvas.renderAll();
        }

        function updateBleedMode() {
            const isBleed = document.getElementById('bleedToggle').checked;
            document.body.classList.toggle('bleed-active', isBleed);
            canvases.forEach(canvas => updateCanvasClip(canvas));
        }

        function toggleAllSync(isChecked) { document.querySelectorAll('.sync-check').forEach(chk => chk.checked = isChecked); }
        function manualSyncToggle(i) { const chk = document.getElementById('sync' + i); chk.checked = !chk.checked; }

        function loadImage(event, index) {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (f) => {
                fabric.Image.fromURL(f.target.result, (img) => {
                    img.set({ originX: 'center', originY: 'center', left: CENTER, top: CENTER });
                    img.scale(SIZE / Math.min(img.width, img.height));
                    canvases[index].add(img).setActiveObject(img); 
                    canvases[index].renderAll(); saveState();
                });
            };
            reader.readAsDataURL(file);
        }

        function loadAllImages(event) {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (f) => {
                canvases.forEach(canvas => {
                    fabric.Image.fromURL(f.target.result, (img) => {
                        img.set({ originX: 'center', originY: 'center', left: CENTER, top: CENTER });
                        img.scale(SIZE / Math.min(img.width, img.height));
                        canvas.add(img); canvas.renderAll();
                    });
                });
                setTimeout(saveState, 500);
            };
            reader.readAsDataURL(file);
        }

        function addText() {
            const text = new fabric.IText('ë¬¸êµ¬ ì…ë ¥', { 
                left: CENTER, top: CENTER, originX: 'center', originY: 'center', 
                fontSize: 25, fontFamily: document.getElementById('fontSelect').value,
                fill: document.getElementById('textColor').value 
            });
            canvases[0].add(text).setActiveObject(text); canvases[0].renderAll(); saveState();
        }

        function updateFont() {
            const font = document.getElementById('fontSelect').value;
            canvases.forEach(canvas => {
                canvas.getActiveObjects().forEach(obj => { if (obj.type === 'i-text') obj.set('fontFamily', font); });
                canvas.renderAll();
            });
            saveState();
        }

        function updateTextColor() {
            const color = document.getElementById('textColor').value;
            canvases.forEach(canvas => {
                canvas.getActiveObjects().forEach(obj => { if (obj.type === 'i-text') obj.set('fill', color); });
                canvas.renderAll();
            });
        }

        function saveState() {
            const state = canvases.map(c => JSON.stringify(c.toJSON()));
            if (historyStack.length > 0 && JSON.stringify(historyStack[historyStack.length-1]) === JSON.stringify(state)) return;
            historyStack.push(state); if (historyStack.length > 15) historyStack.shift();
        }

        function undo() {
            if (historyStack.length <= 1) return;
            historyStack.pop();
            const prev = historyStack[historyStack.length - 1];
            prev.forEach((json, i) => { canvases[i].loadFromJSON(json, () => { updateCanvasClip(canvases[i]); canvases[i].renderAll(); }); });
        }

        function deleteSelected() { canvases.forEach(c => { c.getActiveObjects().forEach(obj => c.remove(obj)); c.discardActiveObject().renderAll(); }); saveState(); }
        function clearAll() { if(confirm("ëª¨ë“  ì‘ì—…ì„ ì´ˆê¸°í™”í• ê¹Œìš”?")) { canvases.forEach(c => { c.clear(); updateCanvasClip(c); }); saveState(); } }

        async function exportFile(format) {
            const page = document.getElementById('labelPage');
            const noPrint = document.querySelectorAll('.no-print');
            const slots = document.querySelectorAll('.circle-slot');
            noPrint.forEach(el => el.style.opacity = '0');
            slots.forEach(s => { s.style.webkitMaskImage = 'none'; s.style.maskImage = 'none'; });
            const canvasCap = await html2canvas(page, { scale: 3, useCORS: true, backgroundColor: "#ffffff" });
            if (format === 'pdf') {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                pdf.addImage(canvasCap.toDataURL('image/jpeg', 1.0), 'JPEG', 0, 0, 210, 297);
                pdf.save('label.pdf');
            } else {
                const link = document.createElement('a');
                link.download = `label.${format}`;
                link.href = canvasCap.toDataURL(format==='jpg'?'image/jpeg':'image/png', 1.0);
                link.click();
            }
            slots.forEach(s => { s.style.webkitMaskImage = 'radial-gradient(circle, white 100%, black 100%)'; s.style.maskImage = 'radial-gradient(circle, white 100%, black 100%)'; });
            noPrint.forEach(el => el.style.opacity = '1');
        }

        function initDraggable(el) {
            let p1 = 0, p2 = 0, p3 = 0, p4 = 0; const h = document.getElementById("dragHandle");
            h.onmousedown = (e) => { 
                if (e.target !== h) return;
                e.preventDefault(); p3 = e.clientX; p4 = e.clientY; 
                document.onmouseup = () => { document.onmouseup = null; document.onmousemove = null; }; 
                document.onmousemove = (e) => { p1 = p3 - e.clientX; p2 = p4 - e.clientY; p3 = e.clientX; p4 = e.clientY; el.style.top = (el.offsetTop - p2) + "px"; el.style.left = (el.offsetLeft - p1) + "px"; }; 
            };
        }
    </script>
</div>
</body>
</html>
